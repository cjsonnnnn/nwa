pipeline {
  agent { label 'agent-azure-net' }

  tools {
    jfrog 'jfrog-cli'
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }

  parameters {
    string(
      name: 'IMAGE_TAG',
      description: 'Version tag (used for .NET publish ZIP and artifact versioning)'
    )
    choice(
      name: 'DEPLOY_ENV',
      choices: ['STAGING', 'PROD', 'DEVL', 'TEST'],
      description: 'Select target environment for deployment'
    )
  }

  environment {
    APP_NAME = "simple-dotnet-app"
    APP_VERSION = "${params.IMAGE_TAG}"
    ARTIFACT_PATH = "${REPO}/dotnet/${APP_VERSION}/${ZIP_PATH}"
    ARTIFACTORY_BASE = "https://${REGISTRY_HOST}/artifactory"
    AZURE_APP_ID = credentials('azure-app-id')
    AZURE_SECRET_KEY = credentials('azure-secret-key')
    AZURE_TENANT_ID = credentials('azure-tenant-id')
    COMPONENT = "reporting-service"
    REGISTRY_HOST = "jfrog.fata-organa.com"
    REPO = "example-repo-local"
    RESOURCE_GROUP = "BelugaBoxResourceGroup01"
    WEBAPP_NAME = "NWAAppServiceCodeTEST"
    ZIP_PATH = "app.zip"
  }

  stages {
    stage('Build and Package') {
      steps {
        script {
          if (!params.IMAGE_TAG) {
            error "IMAGE_TAG is required"
          }
        }
        sh "pwd"
        sh "ls -la"
        sh "ls -la $HOME"

        // ‚öôÔ∏è Set server to use 
        jf 'c use jfart-fos-1'

        // üß™ sanity check connectivity
        jf 'rt ping'

        // üî® Restore and build the .NET project
        retry(3) {
          sh "dotnet restore"
          sh "dotnet publish -c Release -o publish"
        }

        // üì¶ Zip published files
        sh "cd publish && zip -r ../${ZIP_PATH} . && cd .."
        sh "ls -lh ${ZIP_PATH}"

        // Report the build and its produced artifact
        script {
          reportBuild(
            applicationName: env.APP_NAME,
            applicationVersion: env.APP_VERSION,
            applicationComponent: env.COMPONENT,
            artifactFileName: env.ZIP_PATH,
            artifactFileSizeLimit: 50 * 1024 * 1024 // i.e., 50MB cap
          )
        }
      }
    }

    stage('Publish to Artifactory') {
      steps {
        jf "rt bce ${APP_NAME} ${APP_VERSION}"
        jf "rt u ${ZIP_PATH} ${REPO}/dotnet/${APP_VERSION}/ --flat=true"
        jf "rt bp ${APP_NAME} ${APP_VERSION}"
      }
    }

    stage('Report Release to DevOps Portal') {
      steps {
        script {
          reportArtifactRelease(
            applicationName: env.APP_NAME,
            applicationVersion: env.APP_VERSION,
            applicationComponent: env.COMPONENT,
            repositoryName: env.REGISTRY_HOST,
            artifactName: "${COMPONENT}/${APP_VERSION}/${ZIP_PATH}",
            tags: env.APP_VERSION,
            artifactURL: "${ARTIFACTORY_BASE}/${ARTIFACT_PATH}"
          )
        }
      }
    }

    stage('Approve for Production') {
      when {
        expression { params.DEPLOY_ENV == 'PROD' }
      }
      steps {
        script {
          timeout(time: 1, unit: 'HOURS') {
            input message: "Approve deployment to Production?", ok: "Yes, deploy", 
                  submitter: "manager"
          }
        }
      }
    }

    stage('Deploy to Azure App Service') {
      steps {
        sh "git --version"
        sh "which git"
        sh "pwd"
        sh "ls -la"
        sh "ls -la $HOME"

        // üîê Log in to Azure using Service Principal...
        sh "az version"
        sh '''
          az login --service-principal \
            --username "$AZURE_APP_ID" \
            --password "$AZURE_SECRET_KEY" \
            --tenant "$AZURE_TENANT_ID"
        '''
        sh "az account show"

        // ‚öôÔ∏è Set server to use 
        jf 'c use jfart-fos-1'

        // üîΩ Download published ZIP from Artifactory
        retry(3) {
          jf "rt dl example-repo-local/dotnet/${params.IMAGE_TAG}/app.zip --flat=true"
        }
        sh "ls -la"

        // üöÄ Deploy the JAR to App Service
        sh """
          az webapp deploy \
            --resource-group ${RESOURCE_GROUP} \
            --name ${WEBAPP_NAME} \
            --src-path app.zip \
            --type zip
        """

        // Report deployment to DevOps Portal
        script{
          reportDeployOperation(
            targetService: "DEVL",
            applicationName: env.APP_NAME,
            applicationVersion: env.APP_VERSION,
            applicationComponent: env.COMPONENT,
            tags: env.APP_VERSION
          )
        }
      }
    }
  }
}
