pipeline {
  agent { label 'agent-ansible-net' }

  options {
    skipDefaultCheckout(true)
  }

  environment {
    APP_NAME = "nwa"
    DOCKERHUB_REPO = "jpiay/${APP_NAME}"
    PI_CREDS=credentials('ssh-vm-jenkins')
  }

  stages {
    stage('Prepare Version') {
      steps {
        script {
          currentBuild.displayName = "Release-${currentBuild.number}"
          env.APP_VERSION = "${params.IMAGE_TAG.tokenize(' ')[0]}"
        }
      }
    }

    stage('Approval for Production') {
      when {
        expression { params.DEPLOY_ENV == 'PROD' }
      }
      steps {
        script {
          timeout(time: 1, unit: 'HOURS') {
            input message: "Approve deployment to Production?",
                  ok: "Deploy Now", submitter: "manager"
          }
        }
      }
    }

    // stage('Prepare SSH & Checkout Ansible Repo') {
    //   steps {
    //     sh '''
    //       ls -al
    //       pwd
    //       mkdir -p ~/.ssh
    //       chmod 700 ~/.ssh
    //       ssh-keyscan github.com >> ~/.ssh/known_hosts
    //       chmod 644 ~/.ssh/known_hosts
    //     '''
    //     git branch: 'main',
    //       url: 'git@github.com:jpiay/fos-ansible.git',
    //       credentialsId: 'ssh-ansible-ctrl'
    //     sh 'ls -al'
    //   }
    // }
    stage('Prepare SSH & Checkout Ansible Repo') {
      steps {
        withCredentials([sshUserPrivateKey(credentialsId: 'ssh-ansible-ctrl', keyFileVariable: 'SSH_PRIVATE_KEY')]) {
          sh '''
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            cp $SSH_PRIVATE_KEY ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            git clone -b main git@github.com:jpiay/fos-ansible.git
          '''
        }
      }
    }

    stage('Deploy to Server') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-jpiay',
                                          usernameVariable: 'DOCKERHUB_USER',
                                          passwordVariable: 'DOCKERHUB_PASS')]) {
          sh """
              ansible-playbook playbooks/cd/nmf/deploy.yml \
                -i inventory \
                --limit localhost \
                -e DOCKERHUB_USERNAME=${DOCKERHUB_USER} \
                -e DOCKERHUB_PASSWORD=${DOCKERHUB_PASS} \
                -e DOCKERHUB_REPO=${DOCKERHUB_REPO} \
                -e APP_NAME=${APP_NAME} \
                -e APP_VERSION=${APP_VERSION}
            """
        }
      }
    }
  }
}
