pipeline {
  agent { label 'agent-azure-net' }

  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
    skipDefaultCheckout(true)
  }

  environment {
    APP_NAME = "nwa"
    DOCKERHUB_REPO = "jpiay/${APP_NAME}"
    PI_CREDS=credentials('ssh-vm-lab3')
  }

  stages {
    stage('Prepare Version') {
      steps {
        script {
          currentBuild.displayName = "Release-${currentBuild.number}"
          env.APP_VERSION = "${params.IMAGE_TAG.tokenize(' ')[0]}"
        }
      }
    }

    stage('Approval for Production') {
      when {
        expression { params.DEPLOY_ENV == 'PROD' }
      }
      steps {
        script {
          timeout(time: 1, unit: 'HOURS') {
            input message: "Approve deployment to Production?",
                  ok: "Deploy Now", submitter: "manager"
          }
        }
      }
    }

    stage('Deploy Docker Image to Azure') {
      steps {
        script {
          // Build remote host config using Jenkins credentials
          def remote = [
            name: "vm-lab3",
            host: "192.168.18.23",
            allowAnyHosts: true,
            user: env.PI_CREDS_USR,
            password: env.PI_CREDS_PSW,
            port: 22
          ]

          echo "üöÄ Pulling image: ${DOCKERHUB_REPO}:${APP_VERSION}"
          sshCommand remote: remote, command: "docker pull ${DOCKERHUB_REPO}:${APP_VERSION}"

          echo "üõë Stopping old container..."
          sshCommand remote: remote, command: "docker stop ${APP_NAME} || true"
          sshCommand remote: remote, command: "docker rm ${APP_NAME} || true"

          echo "‚ñ∂Ô∏è Starting new container..."
          sshCommand remote: remote, command: "docker run -d --name ${APP_NAME} -p 8080:80 ${DOCKERHUB_REPO}:${APP_VERSION}"

          echo "‚úîÔ∏è Deployment completed on VM."
        }
      }
    }
  }
}
